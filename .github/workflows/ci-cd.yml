name: "CI/CD"

on:
  pull_request:
    branches:
      - master
      - dev
      - net10
  push:
    branches:
      - master
      - dev
      - net10
    tags:
      - v*

env:
  # å®šä¹‰æ‰€æœ‰éœ€è¦æ„å»º/æµ‹è¯•/æ‰“åŒ…çš„è§£å†³æ–¹æ¡ˆè·¯å¾„
  SOLUTION_PATHS: |
    framework
    modules/file-storing-database
    modules/file-storing-management
    modules/map-tenancy-management
    modules/tenant-group-management
    modules/dbconnections
    modules/Identity
    modules/IdentityServer
    modules/openiddict
    modules/audit-logging
    modules/account
    modules/minid
    modules/crypto-vault
    modules/transform-security-management

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x

    - name: Extract version from tag
      if: startsWith(github.ref, 'refs/tags/v')
      id: version
      shell: bash
      run: |
        tag="${{ github.ref_name }}"
        version="${tag#v}"
        echo "VERSION=$version" >> $GITHUB_OUTPUT
        echo "TAG=$tag" >> $GITHUB_OUTPUT
        echo "Release version: $version"

    - name: Build All Solutions
      shell: bash
      run: |
        solutions=(
          "framework"
          "modules/file-storing-database"
          "modules/file-storing-management"
          "modules/map-tenancy-management"
          "modules/tenant-group-management"
          "modules/dbconnections"
          "modules/Identity"
          "modules/IdentityServer"
          "modules/openiddict"
          "modules/audit-logging"
          "modules/account"
          "modules/minid"
          "modules/crypto-vault"
          "modules/transform-security-management"
        )

        for solution in "${solutions[@]}"; do
          echo "::group::Building solution: $solution"
          dotnet build "$solution" -c Release
          if [ $? -ne 0 ]; then
            echo "::error::Build failed for solution: $solution"
            exit 1
          fi
          echo "::endgroup::"
        done
        echo "âœ“ All solutions built successfully!"

    - name: Test All Solutions
      shell: bash
      run: |
        solutions=(
          "framework"
          "modules/file-storing-database"
          "modules/file-storing-management"
          "modules/map-tenancy-management"
          "modules/tenant-group-management"
          "modules/dbconnections"
          "modules/Identity"
          "modules/IdentityServer"
          "modules/openiddict"
          "modules/audit-logging"
          "modules/account"
          "modules/minid"
          "modules/crypto-vault"
          "modules/transform-security-management"
        )

        for solution in "${solutions[@]}"; do
          echo "::group::Testing solution: $solution"
          dotnet test "$solution" --no-build -c Release
          if [ $? -ne 0 ]; then
            echo "::error::Test failed for solution: $solution"
            exit 1
          fi
          echo "::endgroup::"
        done
        echo "âœ“ All tests passed successfully!"

    # ä»¥ä¸‹æ­¥éª¤ä»…åœ¨ tag æ¨é€æ—¶æ‰§è¡Œ
    - name: Pack All Solutions
      if: startsWith(github.ref, 'refs/tags/v')
      shell: bash
      run: |
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p dest

        solutions=(
          "framework"
          "modules/file-storing-database"
          "modules/file-storing-management"
          "modules/map-tenancy-management"
          "modules/tenant-group-management"
          "modules/dbconnections"
          "modules/Identity"
          "modules/IdentityServer"
          "modules/openiddict"
          "modules/audit-logging"
          "modules/account"
          "modules/minid"
          "modules/crypto-vault"
          "modules/transform-security-management"
        )

        for solution in "${solutions[@]}"; do
          echo "::group::Packing solution: $solution"
          dotnet pack "$solution" -c Release --include-symbols --no-build -o dest
          if [ $? -ne 0 ]; then
            echo "::error::Pack failed for solution: $solution"
            exit 1
          fi
          echo "::endgroup::"
        done
        echo "âœ“ All solutions packed successfully!"

    - name: Publish to NuGet
      if: startsWith(github.ref, 'refs/tags/v')
      shell: bash
      run: |
        echo "Publishing NuGet packages..."

        # æ£€æŸ¥ dest ç›®å½•æ˜¯å¦å­˜åœ¨
        if [ ! -d "dest" ]; then
          echo "::error::dest directory does not exist"
          exit 1
        fi

        # è·å–æ‰€æœ‰ .nupkg æ–‡ä»¶ï¼ˆæ’é™¤ symbols åŒ…ï¼‰
        shopt -s nullglob
        packages=(dest/*.nupkg)
        filtered_packages=()

        for pkg in "${packages[@]}"; do
          if [[ ! "$pkg" == *.symbols.nupkg ]]; then
            filtered_packages+=("$pkg")
          fi
        done

        if [ ${#filtered_packages[@]} -eq 0 ]; then
          echo "::error::No NuGet packages found in dest directory"
          exit 1
        fi

        echo "Found ${#filtered_packages[@]} packages to publish"

        # å‘å¸ƒæ¯ä¸ªåŒ…
        for package in "${filtered_packages[@]}"; do
          echo "::group::Publishing: $(basename "$package")"
          dotnet nuget push "$package" -k ${{secrets.NUGET_API_KEY}} -s https://www.nuget.org --skip-duplicate
          if [ $? -ne 0 ]; then
            echo "::error::Failed to publish: $(basename "$package")"
            exit 1
          fi
          echo "::endgroup::"
        done

        echo "âœ“ All NuGet packages published successfully!"

    - name: Generate release notes
      if: startsWith(github.ref, 'refs/tags/v')
      id: release_notes
      shell: pwsh
      run: |
        $currentTag = "${{ steps.version.outputs.TAG }}"

        # è·å–ä¸Šä¸€ä¸ª tag
        $previousTag = git describe --tags --abbrev=0 "$currentTag^" 2>$null

        if ($previousTag) {
          Write-Host "Generating changelog from $previousTag to $currentTag" -ForegroundColor Cyan

          # è·å–ä¸¤ä¸ª tag ä¹‹é—´çš„æäº¤å†å²
          $commits = git log "$previousTag..$currentTag" --pretty=format:"%h - %s (%an)" --no-merges

          # æ ¼å¼åŒ–ä¸º markdown åˆ—è¡¨
          $changelog = ""
          if ($commits) {
            $commitLines = $commits -split "`n"
            foreach ($commit in $commitLines) {
              $changelog += "- $commit`n"
            }
          }

          # ç»Ÿè®¡ä¿¡æ¯
          $commitCount = ($commits -split "`n").Count
          $changedFiles = (git diff --name-only "$previousTag..$currentTag" | Measure-Object).Count
        } else {
          Write-Host "No previous tag found, this is the first release" -ForegroundColor Yellow
          $changelog = "This is the first release."
          $commitCount = 0
          $changedFiles = 0
        }

        # ç”Ÿæˆ Release Notes
        $delimiter = "EOF_DELIMITER_$(Get-Random)"
        $notes = @"
        ## SharpAbp ${{ steps.version.outputs.VERSION }}

        ### ğŸ“¦ NuGet Packages
        This release has been published to NuGet.org. You can install the packages using:
        ``````bash
        dotnet add package <PackageName> --version ${{ steps.version.outputs.VERSION }}
        ``````

        ### ğŸ“ What's Changed
        $(if ($previousTag) { "**$commitCount commits** | **$changedFiles files changed** | Changes from [\`$previousTag\`](https://github.com/${{ github.repository }}/releases/tag/$previousTag) to [\`$currentTag\`](https://github.com/${{ github.repository }}/releases/tag/$currentTag)" } else { "" })

        $changelog

        ### ğŸ”— Useful Links
        - [NuGet Gallery](https://www.nuget.org/profiles/SharpAbp)
        - [Documentation](https://github.com/${{ github.repository }})
        $(if ($previousTag) { "- [Full Changelog](https://github.com/${{ github.repository }}/compare/$previousTag...$currentTag)" } else { "" })

        ---
        ğŸ¤– This release was automatically created by GitHub Actions
        "@

        echo "NOTES<<$delimiter" >> $env:GITHUB_OUTPUT
        echo "$notes" >> $env:GITHUB_OUTPUT
        echo "$delimiter" >> $env:GITHUB_OUTPUT

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        name: Release ${{ steps.version.outputs.VERSION }}
        body: ${{ steps.release_notes.outputs.NOTES }}
        draft: false
        prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}
        files: |
          dest/*.nupkg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
