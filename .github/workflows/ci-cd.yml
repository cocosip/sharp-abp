name: "CI/CD"

on:
  pull_request:
    branches:
      - master
      - dev
      - net10
  push:
    branches:
      - master
      - dev
      - net10
    tags:
      - v*

env:
  # ÂÆö‰πâÊâÄÊúâÈúÄË¶ÅÊûÑÂª∫/ÊµãËØï/ÊâìÂåÖÁöÑËß£ÂÜ≥ÊñπÊ°àË∑ØÂæÑ
  SOLUTION_PATHS: |
    framework
    modules/file-storing-database
    modules/file-storing-management
    modules/map-tenancy-management
    modules/tenant-group-management
    modules/dbconnections
    modules/Identity
    modules/IdentityServer
    modules/openiddict
    modules/audit-logging
    modules/account
    modules/minid
    modules/crypto-vault
    modules/transform-security-management

jobs:
  build-and-test:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x

    - name: Extract version from tag
      if: startsWith(github.ref, 'refs/tags/v')
      id: version
      shell: pwsh
      run: |
        $tag = "${{ github.ref_name }}"
        $version = $tag -replace '^v', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "TAG=$tag" >> $env:GITHUB_OUTPUT
        echo "Release version: $version"

    - name: Build All Solutions
      shell: pwsh
      run: |
        $solutions = @(
          "framework",
          "modules/file-storing-database",
          "modules/file-storing-management",
          "modules/map-tenancy-management",
          "modules/tenant-group-management",
          "modules/dbconnections",
          "modules/Identity",
          "modules/IdentityServer",
          "modules/openiddict",
          "modules/audit-logging",
          "modules/account",
          "modules/minid",
          "modules/crypto-vault",
          "modules/transform-security-management"
        )

        foreach ($solution in $solutions) {
          Write-Host "Building solution: $solution" -ForegroundColor Cyan
          dotnet build "$solution" -c Release
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Build failed for solution: $solution"
            exit $LASTEXITCODE
          }
        }
        Write-Host "All solutions built successfully!" -ForegroundColor Green

    - name: Test All Solutions
      shell: pwsh
      run: |
        $solutions = @(
          "framework",
          "modules/file-storing-database",
          "modules/file-storing-management",
          "modules/map-tenancy-management",
          "modules/tenant-group-management",
          "modules/dbconnections",
          "modules/Identity",
          "modules/IdentityServer",
          "modules/openiddict",
          "modules/audit-logging",
          "modules/account",
          "modules/minid",
          "modules/crypto-vault",
          "modules/transform-security-management"
        )

        foreach ($solution in $solutions) {
          Write-Host "Testing solution: $solution" -ForegroundColor Cyan
          dotnet test "$solution" --no-build -c Release
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Test failed for solution: $solution"
            exit $LASTEXITCODE
          }
        }
        Write-Host "All tests passed successfully!" -ForegroundColor Green

    # ‰ª•‰∏ãÊ≠•È™§‰ªÖÂú® tag Êé®ÈÄÅÊó∂ÊâßË°å
    - name: Pack All Solutions
      if: startsWith(github.ref, 'refs/tags/v')
      shell: pwsh
      run: |
        # ÂàõÂª∫ËæìÂá∫ÁõÆÂΩï
        New-Item -ItemType Directory -Force -Path "dest" | Out-Null

        $solutions = @(
          "framework",
          "modules/file-storing-database",
          "modules/file-storing-management",
          "modules/map-tenancy-management",
          "modules/tenant-group-management",
          "modules/dbconnections",
          "modules/Identity",
          "modules/IdentityServer",
          "modules/openiddict",
          "modules/audit-logging",
          "modules/account",
          "modules/minid",
          "modules/crypto-vault",
          "modules/transform-security-management"
        )

        foreach ($solution in $solutions) {
          Write-Host "Packing solution: $solution" -ForegroundColor Cyan
          dotnet pack "$solution" -c Release --include-symbols --no-build -o dest
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Pack failed for solution: $solution"
            exit $LASTEXITCODE
          }
        }
        Write-Host "All solutions packed successfully!" -ForegroundColor Green

    - name: Publish to NuGet
      if: startsWith(github.ref, 'refs/tags/v')
      shell: pwsh
      run: |
        Write-Host "Publishing NuGet packages..." -ForegroundColor Cyan
        dotnet nuget push dest/*.nupkg -k ${{secrets.NUGET_API_KEY}} -s https://www.nuget.org --skip-duplicate
        if ($LASTEXITCODE -ne 0) {
          Write-Error "NuGet publish failed"
          exit $LASTEXITCODE
        }
        Write-Host "NuGet packages published successfully!" -ForegroundColor Green

    - name: Generate release notes
      if: startsWith(github.ref, 'refs/tags/v')
      id: release_notes
      shell: pwsh
      run: |
        $delimiter = "EOF_DELIMITER_$(Get-Random)"
        $notes = @"
        ## SharpAbp ${{ steps.version.outputs.VERSION }}

        ### üì¶ NuGet Packages
        This release has been published to NuGet.org. You can install the packages using:
        ``````
        dotnet add package <PackageName> --version ${{ steps.version.outputs.VERSION }}
        ``````

        ### üìù Changes
        See the full changelog below for detailed changes in this release.

        ### üîó Links
        - [NuGet Gallery](https://www.nuget.org/profiles/SharpAbp)
        - [Documentation](https://github.com/${{ github.repository }})

        ---
        ü§ñ This release was automatically generated by GitHub Actions.
        "@
        echo "NOTES<<$delimiter" >> $env:GITHUB_OUTPUT
        echo "$notes" >> $env:GITHUB_OUTPUT
        echo "$delimiter" >> $env:GITHUB_OUTPUT

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        name: Release ${{ steps.version.outputs.VERSION }}
        body: ${{ steps.release_notes.outputs.NOTES }}
        draft: false
        prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}
        generate_release_notes: true
        files: |
          dest/*.nupkg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
